<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="import-moment.html">
<link rel="import" href="import-countup.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <arbitrary-number-countdown></arbitrary-number-countdown>

@group Seed Elements
@element arbitrary-number-countdown
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="arbitrary-number-countdown">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;

      }

      h1{
        font-size: 120px;
        text-transform: uppercase;
        @apply(--arbitrary-number-countdown-styles);

      }
      strong {
        @apply(--arbitrary-number-countdown-strong-styles);
      }
    </style>

    <span id="remaining"></span>
    Number Per Second: {{numberPerSecond}}
    <content></content>

  </template>

</dom-module>

<script>

  Polymer({

    is: 'arbitrary-number-countdown',

    properties: {

      /**
       * `timezone` not UTC specific Moment.js data. Example America/Los_Angeles
       */
      timezone: {
        type: String,
        value: function() { return 'America/Los_Angeles'; }
      },

      /**
       * `expiredDate` Date the countdown hits 0
       */
      expiredDate: String,

      /**
       * `baseNumber` number for 1 complete day.
       */
      baseNumber: String,

      numberPerSecond: Number,
      remaining: String,

      days: {
        type: Number,
        observer: 'timeUpdated'
      },

      hours: {
        type: Number,
        observer: 'timeUpdated'
      },


    },



    // Element Lifecycle

    ready: function() {

      moment.tz.setDefault(this.timezone);
      this.expiredDate = moment.tz(this.expiredDate, this.timezone);

      var today = moment().format();

      // calculating the amount per second
      let perSecond = parseFloat(this.baseNumber) / (60 * 60 * 24); // (seconds * minutes * hours)
      this.numberPerSecond = perSecond.toFixed();


      let remaining = this.expiredDate.diff(today, 'seconds') * this.numberPerSecond;
      this.remaining = remaining.toLocaleString();

      // Set the Interval
      this.set('interval', setInterval(this.timerStarted.bind(this), 1000));
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
      clearInterval(this.get('interval'));
    },

    // Element Behavior

    /**
     * Starting timer for those few cases that roll over the hour
     *
     */
    timerStarted: function() {
        var now = moment().format();

        let remaining = this.expiredDate.diff(now, 'seconds') * this.numberPerSecond;
        let prev      = parseInt(this.get('remaining').replace(/,/g, '')); // convert string output to number

        if(remaining !== prev) {

          var options = {
            useEasing : false,
            useGrouping : true,
            separator : ',',
            decimal : '.',
            prefix : '',
            suffix : ''
          };

          var animRemaining = new CountUp("remaining", prev, remaining, 0, 1.5, options);
          animRemaining.start(function() {
              animRemaining.update(remaining);
          });

          this.remaining = remaining.toLocaleString();
        }
        // for(let i = prev; i > remaining; i - 10) {
        //     console.log(i);
        //
        // }

    },

    /**
     * Observer for timer to display plural or singular verbage
     *
     */
    timeUpdated: function() {
      // if(this.hoursTxt !== undefined) {
      //   this.hoursTxt.output = this.hours === 1 ? this.hoursTxt.singular : this.hoursTxt.plural;
      //   this.set('hoursTxt.output', this.hoursTxt.output);
      // }
      //
      // if(this.daysTxt !== undefined) {
      //   this.daysTxt.output = this.days <= 1 ? this.daysTxt.singular : this.daysTxt.plural;
      //   this.set('daysTxt.output', this.daysTxt.output);
      //
      // }

    },


  });

</script>
